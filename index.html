<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Sơ Đồ Gia Phả</title>

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Tac+One&display=swap" rel="stylesheet">
    
    <link href="manifest.json" rel="manifest">
    <link href="favicon.ico" rel="icon" type="image/x-icon">

    <link rel="stylesheet" href="styles.css">

    <script src="https://cdnjs.cloudflare.com/ajax/libs/hammer.js/2.0.8/hammer.min.js"></script>

    <script>
      function startApp() {
        gapi.load('client', initializeGapiClient);
      }
      window.gapiLoaded = startApp;
      window.gisLoaded = () => {};
    </script>
</head>
<body data-theme='dark'>
    <header id='app-header'>
      <button class='btn' id='btnToggleSidebar' title='Ẩn/hiện thanh điều khiển'>
        <svg fill='none' height='24' stroke='currentColor' stroke-linecap='round' stroke-linejoin='round' stroke-width='2' viewBox='0 0 24 24' width='24' xmlns='http://www.w3.org/2000/svg'><line x1='3' x2='21' y1='12' y2='12'/><line x1='3' x2='21' y1='6' y2='6'/><line x1='3' x2='21' y1='18' y2='18'/></svg>
      </button>
      <div id='tree-selector-wrapper'>
        <select id='tree-selector' title='Chọn Phả Đồ'></select>
      </div>
      <h1 id='appTitle'>SƠ ĐỒ GIA PHẢ</h1>
    </header>
    <div class='app sidebar-collapsed'>
      <div id='overlay'></div>

      <aside class='panel left'>
        <header>
          <h1>Bảng điều khiển</h1>
          <div class='sub'>Tùy chỉnh và quản lý sơ đồ</div>
          <div id='auth-container' style='padding-top: 10px; font-size: 13px;'></div>
        </header>
        <div class='toolbar'>
          <button class='btn owner-only-field' disabled='true' id='btnSaveChanges' style='grid-column: 1 / -1; background: var(--accent); color: white;'>Lưu Thay Đổi</button>
          <button class='btn owner-only-field' id='btnRoot'>+ Tạo gốc</button>
          <button class='btn owner-only-field' id='btnUndo' title='Hoàn tác (Ctrl+Z)'>&#8630; Undo</button>
          <button class='btn owner-only-field' id='btnRedo' title='Làm lại (Ctrl+Y)'>&#8631; Redo</button>
          <button class='btn owner-only-field' id='btnImportCSV'>Nhập CSV/Excel</button>
          <button class='btn' id='btnExportCSV'>Xuất CSV</button>
          <button class='btn' id='btnExportSVG'>Xuất SVG</button>
          <button class='btn' id='btnExportJPG'>Xuất JPG</button>
          <button class='btn owner-only-field' id='btnReset'>Xóa sạch</button>
        </div>
        <div class='scroll'>
          
          <div class='field owner-only-field' style='padding: 0 12px;'>
            <label>URL Ảnh nền</label>
            <div class='btn-group'>
               <input id='bgUrlInput' placeholder='Dán link ảnh mới vào đây...' style='flex:1; width: 100%;'>
            </div>
          </div>

          <div class='field' style='padding: 0 12px;'>
              <label>Giao diện</label>
              <select class='btn' id='themeSelector' style='width: 100%; padding: 10px 12px;'>
                  <option value='dark'>Mặc định - Tối</option>
                  <option value='light'>Mặc định - Sáng</option>
                  <option value='sepia'>Nâu Cổ Điển - Sáng</option>
                  <option value='deep-sea'>Biển Sâu - Tối</option>
                  <option value='slate'>Thạch Lam - Tối</option>
              </select>
          </div>
          
          <div class='field owner-only-field' id='gap-control-field' style='padding: 0 12px;'>
            <label>Khoảng cách ngang (<span id='gapValueLabel'>40</span>px)</label>
            <input id='gapXSlider' max='150' min='10' style='width:100%' type='range' value='40'>
          </div>

          <div class='field owner-only-field' style='padding: 0 12px; border-top: 1px solid var(--border); margin-top: 12px; padding-top: 12px;'>
              <label style='font-weight: bold; margin-bottom: 8px;'>Tùy chỉnh biểu tượng</label>
              
              <div class='toggle-wrapper' style='display:flex; align-items:center; justify-content:space-between; margin-bottom: 12px;'>
                  <span>Hiển thị biểu tượng</span>
                  <label class='toggle'>
                    <input checked='true' id='toggleDecoration' type='checkbox'>
                  </label>
              </div>

              <label>URL Biểu tượng</label>
              <input id='decorationUrlInput' placeholder='Dán link ảnh mới vào đây...' style='width:100%; margin-bottom: 12px;' type='text'>

              <label>Kích thước (<span id='decorationSizeLabel'>150</span>px)</label>
              <input id='decorationSizeSlider' max='2500' min='50' style='width:100%' type='range' value='150'>
              
              <label style='margin-top: 8px;'>Khoảng cách dọc (<span id='decorationDistanceLabel'>85</span>px)</label>
              <input id='decorationDistanceSlider' max='2500' min='20' style='width:100%' type='range' value='85'>
          </div>
   
            <div class='field' id='stats' style='padding: 0 12px;'>
            <label>Thống kê theo đời</label>
            <div id='stats-content'></div>
          </div>
        </div>
        <div class='hint'>
          <b>Thiết kế:</b> Nguyễn Khánh Linh - 0985934677
        </div>
        <input accept='.csv,.xls,.xml,text/csv,application/vnd.ms-excel' id='fileImportCSV' style='display:none' type='file'>
      </aside>
   
        <main class='panel right'>
        <div class='topbar'>
          <button class='btn' id='btnToggleImageAlbum' title='Mở Album Ảnh'>
            <svg fill='none' height='20' stroke='currentColor' stroke-linecap='round' stroke-linejoin='round' stroke-width='2' viewBox='0 0 24 24' width='20' xmlns='http://www.w3.org/2000/svg'><rect height='18' rx='2' ry='2' width='18' x='3' y='3'/><circle cx='8.5' cy='8.5' r='1.5'/><polyline points='21 15 16 10 5 21'/></svg>
            <span class='tooltip-text'>Ảnh</span>
          </button>
    
           <button class='btn' id='btnToggleAudioAlbum' title='Mở Album Audio'>
             <svg fill='none' height='20' stroke='currentColor' stroke-linecap='round' stroke-linejoin='round' stroke-width='2' viewBox='0 0 24 24' width='20' xmlns='http://www.w3.org/2000/svg'><path d='M9 18V5l12-2v13'/><circle cx='6' cy='18' r='3'/><circle cx='18' cy='16' r='3'/></svg>
             <span class='tooltip-text'>Audio</span>
          </button>
          <button class='btn' id='zoomOut'>&#8722;</button>
          <button class='btn' id='zoomReset'>100%</button>
         <button class='btn' id='zoomIn'>+</button>
        </div>

        <div class='canvas-container' id='canvas-container'>
          <div id='node-icons-container'></div>
          <canvas id='tree-canvas'></canvas>
          <img id='tree-decoration' src=''>
          <div class='panel hidden' id='selection-actions'>
              <div class='selection-header'>
                  <div style="flex-grow: 1;">
                      <h3 id='selection-name-label'>Đang chọn:</h3>
                      <div id='selection-name-value'>No selection</div>
                  </div>
                  <div id='selection-avatar' title='Nhấn để sửa thông tin & ảnh'></div>
              </div>
              <div class='actions-grid'>
                  <button class='btn' id='act-add-child'>
                      <svg fill='none' height='16' stroke='currentColor' stroke-linecap='round' stroke-linejoin='round' stroke-width='2' viewBox='0 0 24 24' width='16'><path d='M6 3v12'/><path d='M18 9v12'/><path d='M3 15h18'/><path d='M14 21v-5a2 2 0 0 0-2-2h-4a2 2 0 0 0-2 2v5'/></svg>
                      Thêm con
                  </button>
                  <button class='btn' id='act-edit-node'>
                      <svg fill='none' height='16' stroke='currentColor' stroke-linecap='round' stroke-linejoin='round' stroke-width='2' viewBox='0 0 24 24' width='16'><path d='M17 3a2.828 2.828 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5L17 3z'/></svg>
                      Sửa
                  </button>
                  <button class='btn' id='act-delete-node' style='background: var(--danger); color: white;'>
                      <svg fill='none' height='16' stroke='currentColor' stroke-linecap='round' stroke-linejoin='round' stroke-width='2' viewBox='0 0 24 24' width='16'><polyline points='3 6 5 6 21 6'/><path d='M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2'/><line x1='10' x2='10' y1='11' y2='17'/><line x1='14' x2='14' y1='11' y2='17'/></svg>
                      Xóa
                  </button>
              </div>
          </div>
          
          <div class='panel hidden' id='info-panel'>
            <div class='info-header'>
                <h3 id='info-name'></h3>
                <div id='info-avatar'></div>
            </div>
            <div class='info-grid'>
              <div class='info-item'>
                <strong>Giáp / Đời:</strong>
                <span id='info-generation'></span>
              </div>
              <div class='info-item inline-label' id='info-birth-item'>
                <strong>Ngày sinh: </strong>
                <span id='info-birth'></span>
              </div>
              <div class='info-item inline-label' id='info-death-item'>
                <strong>Ngày mất: </strong>
                <span id='info-death'></span>
              </div>
              <div class='info-item'>
                <strong>Con cái:</strong>
                <span id='info-sons'></span>
              </div>
              <div class='info-item'>
                <strong>Anh em:</strong>
                <span id='info-brothers'></span>
              </div>
            </div>
          </div>

        </div>
     
        <div id='bottom-right-ui'>
          <div class="button-group-wrapper">
              <div id="search-container">
                  <input id='search' placeholder='Nhập tên để tìm...'>
                  <button id='btnClearSearch' title='Xóa tìm kiếm'>&#215;</button>
                  <button class='btn' id='btnToggleSearch' title='Tìm kiếm'>
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="11" cy="11" r="8"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line></svg>
                  </button>
              </div>
              <button class='btn' id='btnFit' title='Vừa với màn hình'>
                    <svg fill='none' height='24' stroke='currentColor' stroke-linecap='round' stroke-linejoin='round' stroke-width='2' viewBox='0 0 24 24' width='24' xmlns='http://www.w3.org/2000/svg'><path d='M8 3H5a2 2 0 0 0-2 2v3m18 0V5a2 2 0 0 0-2-2h-3m0 18h3a2 2 0 0 0 2-2v-3M3 16v3a2 2 0 0 0 2 2h3'/></svg>
              </button>
          </div>
        </div>
      </main>

      <aside class='panel media-sidebar' id='image-sidebar'>
          <header>
              <div style='flex-grow: 1;'>
                  <h1>Album Hình Ảnh</h1>
                  <div class='sub'>Hình ảnh dòng họ Nguyễn Hồng</div>
              </div>
              <button class='btn' id='btnCloseImage' title='Đóng'>&#215;</button>
          </header>
          <div class='scroll'>
              <div class='media-section'>
                   <div class='gallery' id='media-image-gallery'>
                  </div>
              </div>
          </div>
      </aside>
      
      <aside class='panel media-sidebar' id='audio-sidebar'>
          <header>
              <div style='flex-grow: 1;'>
                  <h1>Album Âm Thanh</h1>
                  <div class='sub'>Audio Lịch sử dòng họ Nguyễn Hồng</div>
              </div>
              <button class='btn' id='btnCloseAudio' title='Đóng'>&#215;</button>
          </header>
          <div class='scroll'>
                 <div class='media-section'>
                  <ul class='playlist' id='media-audio-playlist'>
                  </ul>
              </div>
          </div>
      </aside>

    </div>
    <div class='modal' id='modal'>
        <div class='dialog'>
            <header><h3 id='mTitle'>Thêm thành viên</h3></header>
            <input type="file" id="mAvatarFile" accept="image/png, image/jpeg, image/gif" style="display: none;">
            <div class='body'>
                <label>Họ và tên<input id='mName' placeholder='Nguyễn Văn A' required=''></label>
                <div style='display:grid;grid-template-columns:1fr 1fr;gap:8px'>
                    <label>Năm sinh<input id='mBirth' placeholder='VD: 1950, Canh Dần,...'></label>
                    <label>Năm mất<input id='mDeath' placeholder='VD: 2020, Canh Tý,...'></label>
                </div>
                <label>Ghi chú<textarea id='mNote' placeholder='Thông tin thêm...'></textarea></label>
                <label>URL Ảnh đại diện<input id='mAvatar' placeholder='Dán link ảnh hoặc để trống để tự tải lên...'></label>
            </div>
            <footer>
                <button class='btn' id='mCancel'>Hủy</button>
                <button class='btn' id='mSave'>Lưu</button>
            </footer>
        </div>
    </div>
    <div class='modal' id='confirm'>
      <div class='dialog'>
        <header><h3>Xác nhận</h3></header>
        <div class='body'><div id='cMsg'>Bạn chắc 
        chắn chứ?</div></div>
        <footer>
          <button class='btn' id='cNo'>Hủy</button>
          <button class='btn' id='cYes'>Đồng ý</button>
        </footer>
      </div>
    </div>
    <div class='modal' id='media-viewer'>
      <div class='dialog' style='width:auto; max-width: 90vw; max-height: 90vh;'>
        <header style='display:flex; justify-content:space-between; align-items:center;'>
          <h3 id='media-title'>Xem phương tiện</h3>
          <button class='btn' id='media-close' style='padding: 6px 10px;'>&#215;</button>
        </header>
        <div class='body' id='media-content' style='padding: 0; display:flex; justify-content:center; align-items:center; position: relative;'>
             </div>
      </div>
    </div>
    <audio id='global-audio-player'></audio>
    <script type="text/javascript">window.$crisp=[];window.CRISP_WEBSITE_ID="303f40a9-dda5-4aa4-ba61-870cd1cf8d57";(function(){d=document;s=d.createElement("script");s.src="https://client.crisp.chat/l.js";s.async=1;d.getElementsByTagName("head")[0].appendChild(s);})();</script>
    
    <script src="script.js" defer></script>
</body>
</html>

